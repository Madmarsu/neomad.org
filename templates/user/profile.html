{% extends 'layout.html' %}

{% block extra_css %}
<link rel=stylesheet href={{ url_for('static', filename='css/profile.css') }}>
{% endblock %}

{% block main %}
<header>
  <figure>
    <img class=avatar src={{ user.avatar }} width=100 height=100 onerror="this.src='{{ url_for('static', filename='images/avatar.png') }}'">
  </figure>
  <div>
    <h1 name=username>{{ user.username or 'Insert a username' }}</h1>
    <p name=about>{{ user.about|htmlnewline or 'Introduce yourself here' }}</p>
  </div>
  {% if edit %}
  <form>
    <div>
      <input type=checkbox name=localize {% if user.allow_localization %}checked{% endif %} id=localize><label for=localize title="enable travel tracking services">Save my locations</label>
    </div>
  </form>
  {% endif %}
</header>

<section class=articles>
{% if edit %}
  <article class=preview>
    <h1><span class="newtext title">&nbsp;</span></h1>
    <p><span class=newtext>&nbsp;</span><span class=newtext>&nbsp;</span><span class=newtext>&nbsp;</span></p>
    <a href={{ url_for('article_create') }} class=read>Write this article</a>
  </article>
{% endif %}
{% for article in articles %}
  {% set url = url_for_article(article) %}
  <article class=preview>
    <a href={{ url }}>
      <h1>{{ article.title|title }}</h1>
      {{ article.content|striptags|truncate(200) }}
    </a>
    <a href={{ url }} class=read>Read</a>
  </article>
{% endfor %}
</section>

{% if edit %}
<script>
  const usernameField = document.querySelector('[name=username]')
  usernameField.setAttribute('contenteditable', true)
  usernameField.addEventListener('blur', event => {
    call = api.send('patch', "{{ url_for('profile_edit') }}",
      JSON.stringify({username: event.target.textContent})
    )
  })
  const localizeField = document.querySelector('[name=localize]')
  localizeField.addEventListener('change', event => {
    api.send('patch', "{{ url_for('profile_edit') }}",
      JSON.stringify({allow_localization: event.target.checked})
    )
  })
  const aboutField = document.querySelector('[name=about]')
  aboutField.setAttribute('contenteditable', true)
  aboutField.addEventListener('blur', event => {
    api.send('patch', "{{ url_for('profile_edit') }}",
      JSON.stringify({about: event.target.innerHTML})
    )
  })

  const api = {
    send(method, url, data) {
      return fetch(url, {
        method: method,
        body: data,
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'}
      })
    }
  }
</script>
{% endif %}
{% endblock %}
